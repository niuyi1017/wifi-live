<!DOCTYPE html>
<html>
  <head>
    <title>Sender</title>
    <style>
      video {
        width: 100px;
        height: auto;
      }
    </style>
  </head>
  <body>
    <h1>Sender</h1>
    <video id="localVideo" autoplay></video>
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="zoomInBtn">Zoom In</button>
    <button id="zoomOutBtn">Zoom Out</button>
    <script src="/socket.io/socket.io.js"></script>
    <script src="./js/simplepeer.min.js"></script>
    <script>
      const socket = io();
      const video = document.getElementById("localVideo");
      const startBtn = document.querySelector("#startBtn");
      const stopBtn = document.querySelector("#stopBtn");
      const zoomInBtn = document.querySelector("#zoomInBtn");
      const zoomOutBtn = document.querySelector("#zoomOutBtn");

      let peer = null;
      let stream = null;
      let videoTrack = null;
      let zoomLevel = 1;

      // 本地实时预览摄像头stream
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: false })
        .then((s) => {
          stream = s;
          video.srcObject = stream;
          videoTrack = stream.getVideoTracks()[0];
        })
        .catch((err) => {
          console.error("Error accessing media devices.", err);
        });

      // 点击按钮开始，开始推流
      startBtn.addEventListener("click", () => {
        if (!stream) {
          console.error("No stream available.");
          return;
        }

        startBtn.disabled = true;
        peer = new SimplePeer({ initiator: true, stream: stream });

        peer.on("signal", (data) => {
          socket.emit("signal", data);
        });

        socket.on("signal", (data) => {
          if (peer.destroyed) {
            console.warn("Cannot signal after peer is destroyed");
            return;
          }
          peer.signal(data);
        });

        peer.on("close", () => {
          peer = null;
        });
      });

      stopBtn.addEventListener("click", () => {
        if (peer) {
          peer.destroy();
          peer = null;
        }
        startBtn.disabled = false;
      });

      zoomInBtn.addEventListener("click", () => {
        if (videoTrack) {
          const capabilities = videoTrack.getCapabilities();
          if (capabilities.zoom) {
            zoomLevel = Math.min(zoomLevel + 1, capabilities.zoom.max);
            videoTrack.applyConstraints({ advanced: [{ zoom: zoomLevel }] });
          }
        }
      });

      zoomOutBtn.addEventListener("click", () => {
        if (videoTrack) {
          const capabilities = videoTrack.getCapabilities();
          if (capabilities.zoom) {
            zoomLevel = Math.max(zoomLevel - 1, capabilities.zoom.min);
            videoTrack.applyConstraints({ advanced: [{ zoom: zoomLevel }] });
          }
        }
      });

      window.addEventListener("beforeunload", () => {
        if (peer) {
          peer.destroy();
        }
      });
    </script>
  </body>
</html>
